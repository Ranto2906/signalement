events {
    worker_connections 1024;
}

http {
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=tilecache:100m max_size=2g inactive=30d use_temp_path=off;

    upstream osm_tiles {
        server a.tile.openstreetmap.org;
        server b.tile.openstreetmap.org;
        server c.tile.openstreetmap.org;
    }

    server {
        listen 80;
        server_name localhost;

        # CORS headers
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;

        location / {
            proxy_pass https://a.tile.openstreetmap.org;
            proxy_ssl_server_name on;
            proxy_set_header Host tile.openstreetmap.org;
            proxy_set_header User-Agent "SignalRoute/1.0";
            
            # Cache configuration
            proxy_cache tilecache;
            proxy_cache_valid 200 30d;
            proxy_cache_valid 404 1m;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_lock on;
            
            # Add cache status header for debugging
            add_header X-Cache-Status $upstream_cache_status;
        }
    }
}
